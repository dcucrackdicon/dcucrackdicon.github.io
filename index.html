<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0d0d1a; --frame-bg-dark: rgba(10, 20, 40, 0.85); --text-dark: #e0e0e0; --primary-dark: #00e5ff; --glow-dark: rgba(0, 229, 255, 0.5); --border-dark: rgba(0, 229, 255, 0.3); --input-bg-dark: #1a2a4a; --table-header-dark: #005c66; --table-row-dark: #0e2a3f;
        }
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-dark); color: var(--text-dark); }
        .frame { max-width: 900px; margin: 50px auto; padding: 30px; border-radius: 16px; backdrop-filter: blur(10px); background: var(--frame-bg-dark); border: 1px solid var(--border-dark); box-shadow: 0 0 25px var(--glow-dark); }
        h2 { font-family: 'Orbitron', sans-serif; text-align: center; color: var(--primary-dark); }
        .control-group { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-dark); border-radius: 8px; }
        .input-block { flex: 1; min-width: 200px; }
        label { font-weight: bold; margin-bottom: 5px; display: block; }
        input[type=number], input[type=text], input[type=password] { width: 100%; padding: 10px 15px; box-sizing: border-box; margin: 8px 0; border-radius: 8px; border: 1px solid var(--border-dark); background: var(--input-bg-dark); color: var(--text-dark); font-size: 16px; }
        button { padding: 10px 20px; margin: 10px 5px 0 0; border-radius: 8px; border: none; font-weight: bold; font-family: 'Orbitron', sans-serif; cursor: pointer; transition: all 0.3s; color: #000; background: var(--primary-dark); box-shadow: 0 0 15px var(--glow-dark); }
        button:hover { transform: translateY(-2px); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid var(--border-dark); padding: 10px; text-align: left; word-break: break-all; }
        th { background-color: var(--table-header-dark); font-family: 'Orbitron', sans-serif; }
        td span.status-activated { color: #f39c12; font-weight: bold; }
        td span.status-available { color: #00ff88; font-weight: bold; }
        td span.status-exhausted { color: #ff5577; font-weight: bold; }
        td span.status-expired { color: #95a5a6; font-weight: bold; font-style: italic;}
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="frame" id="admin-panel">
    <h2>ADMIN PANEL</h2>

    <div id="password-gate">
        <div class="control-group">
            <div class="input-block" style="flex-grow: 2;">
                <label for="admin-password">Nhập mật khẩu Admin:</label>
                <input type="password" id="admin-password" placeholder="lồn thằng đông dương" onkeyup="if(event.key === 'Enter') checkAdminPassword()">
            </div>
            <div class="input-block">
                <label>&nbsp;</label>
                <button onclick="checkAdminPassword()" style="width: 100%; margin-top: 8px;">Truy cập</button>
            </div>
        </div>
    </div>

    <div id="main-controls" class="hidden">
        <div class="control-group">
            <div class="input-block">
                <label for="key-days">Số ngày sử dụng:</label>
                <input type="number" id="key-days" value="7" min="1">
            </div>
            <div class="input-block">
                <label for="key-usage-limit">Số lượt dùng (thiết bị):</label>
                <input type="number" id="key-usage-limit" value="1" min="1">
            </div>
            <div class="input-block">
                 <label>&nbsp;</label>
                <button onclick="createKey()" style="width:100%">Tạo Key</button>
            </div>
        </div>

        <div class="control-group">
             <div class="input-block" style="flex-grow: 2;">
                <label for="key-to-delete">Nhập mã key cần xóa:</label>
                <input type="text" id="key-to-delete" placeholder="SUNWIN-XXXX-YYYY">
            </div>
             <div class="input-block">
                <label>&nbsp;</label>
                <button onclick="deleteKey()" style="width:100%">Xóa Key</button>
            </div>
        </div>

        <div style="border: 1px solid var(--border-dark); border-radius: 8px; padding: 15px;">
            <h3>Quản Lý Key</h3>
            <button onclick="loadKeys()">Tải Lại Danh Sách</button>
            <div style="overflow-x:auto;">
                <table id="keys-table">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Hết Hạn</th>
                            <th>Lượt Dùng</th>
                            <th>Trạng Thái</th>
                            <th>Các Thiết Bị</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Dán URL Web App của bạn vào đây.
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxlsFH0KZ8TJ7JvbHPURDfAmyT0OJ1H8rsQmdDzkQEplPBwEb6h1xS9GaDqc0t--FMq/exec"; 

    let adminPassword = 'bucuanhdi';

    function checkAdminPassword() {
        const passInput = document.getElementById('admin-password').value;
        if (!passInput) {
            Swal.fire('Lỗi', 'Vui lòng nhập mật khẩu', 'error');
            return;
        }
        adminPassword = passInput;
        document.getElementById('password-gate').classList.add('hidden');
        document.getElementById('main-controls').classList.remove('hidden');
        loadKeys();
    }

    async function apiCall(params) {
        const url = new URL(SCRIPT_URL);
        params.password = adminPassword;
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
        try {
            const response = await fetch(url, { redirect: 'follow' });
            if (!response.ok) throw new Error('Network response was not ok.');
            return await response.json();
        } catch (error) {
            Swal.fire('Lỗi API', 'Không thể kết nối tới server.', 'error');
            return null;
        }
    }

    async function createKey() {
        const days = document.getElementById('key-days').value;
        // Lấy giá trị từ ô nhập lượt dùng mới
        const usageLimit = document.getElementById('key-usage-limit').value;

        Swal.fire({ title: 'Đang tạo key...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        // Gửi thêm `usageLimit` tới script
        const result = await apiCall({ action: 'create', days: days, usageLimit: usageLimit });
        
        if (result && result.status === 'success') {
            Swal.fire('Thành công', `Đã tạo key mới: ${result.key}`, 'success');
            loadKeys();
        } else {
            Swal.fire('Thất bại', result.message || 'Không thể tạo key.', 'error');
        }
    }
    
    async function deleteKey() {
        const key = document.getElementById('key-to-delete').value.trim();
        if(!key) {
             Swal.fire('Lỗi', 'Vui lòng nhập key cần xóa', 'warning');
             return;
        }
        const result = await apiCall({ action: 'delete', key: key });
        if (result && result.status === 'success') {
            Swal.fire('Thành công', result.message, 'success');
            document.getElementById('key-to-delete').value = '';
            loadKeys();
        } else {
            Swal.fire('Thất bại', result.message || 'Không thể xóa key.', 'error');
        }
    }

    async function loadKeys() {
        Swal.fire({ title: 'Đang tải danh sách key...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        const result = await apiCall({ action: 'getAll' });
        const tableBody = document.querySelector("#keys-table tbody");
        tableBody.innerHTML = '';

        if (result && result.status === 'success') {
            if (result.keys && result.keys.length > 0) {
                result.keys.sort((a, b) => new Date(b.CreatedAt) - new Date(a.CreatedAt));
                result.keys.forEach(k => {
                    const row = tableBody.insertRow();
                    // Cập nhật bảng để hiển thị thông tin mới
                    row.innerHTML = `
                        <td>${k.Key}</td>
                        <td>${k.ExpirationDate}</td>
                        <td>${k.UsageCount} / ${k.UsageLimit}</td>
                        <td><span class="status-${k.Status.toLowerCase()}">${k.Status}</span></td>
                        <td>${k.ActivatedDevices || '---'}</td>
                    `;
                });
            } else {
                 const row = tableBody.insertRow();
                 row.innerHTML = `<td colspan="5" style="text-align: center;">Chưa có key nào được tạo.</td>`;
            }
            Swal.close();
        } else {
            Swal.fire('Thất bại', result.message || 'Không thể tải danh sách key.', 'error');
        }
    }
</script>

</body>
</html>

